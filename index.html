<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risque & M√©t√©o du Morbihan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            opacity: 0.9;
        }

        .last-update {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            opacity: 0.85;
            margin-top: 8px;
            font-style: italic;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
            white-space: nowrap;
        }

        .btn-period {
            background: #e5e7eb;
            color: #4b5563;
        }

        .btn-period.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .btn-display {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-display.active {
            background: #10b981;
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 10px 20px;
            font-size: clamp(0.9rem, 2.5vw, 1rem);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            display: block;
            margin: 20px auto;
            width: fit-content;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            opacity: 0.9;
        }

        footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.3s;
        }

        footer a:hover {
            opacity: 0.7;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 968px) {
            .main-content {
                grid-template-columns: 1fr 350px;
                gap: 20px;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .map-container {
            position: relative;
            background: #f0f0f0;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #map-image {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }

        /* Adaptation mobile pour la carte */
        @media (max-width: 767px) {
            .map-container {
                min-height: 500px;
                max-height: 70vh;
            }
            
            #map-image {
                object-fit: cover;
                object-position: center;
            }
        }

        .weather-icon {
            position: absolute;
            width: clamp(35px, 5vw, 55px);
            height: clamp(35px, 5vw, 55px);
            cursor: pointer;
            transition: all 0.3s;
            transform: translate(-50%, -50%);
            animation: bounce 2s ease-in-out infinite;
            z-index: 10;
        }

        /* R√©duction suppl√©mentaire sur tr√®s petits √©crans */
        @media (max-width: 480px) {
            .weather-icon {
                width: clamp(30px, 4.5vw, 45px);
                height: clamp(30px, 4.5vw, 45px);
            }
        }

        .weather-icon:hover {
            transform: translate(-50%, -50%) scale(1.15);
            z-index: 20;
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-8px); }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .info-card h2 {
            font-size: 1.3rem;
            color: #1e3a8a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-city h3 {
            font-size: 1.4rem;
            color: #1e3a8a;
            margin-bottom: 8px;
        }

        .weather-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .param-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #bae6fd;
        }

        .param-label {
            font-size: 0.85rem;
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .param-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0c4a6e;
        }

        .risk-indicator {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
        }

        .risk-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-bar {
            background: rgba(255,255,255,0.2);
            height: 35px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .risk-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            transition: width 0.5s ease;
        }

        .risk-description {
            font-size: 0.9rem;
            opacity: 0.95;
            line-height: 1.5;
        }

        .risk-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        .risk-badge.orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .risk-badge.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .risk-badge.violet {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .alert-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 5px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .alert-item.vert { border-left-color: #10b981; }
        .alert-item.jaune { border-left-color: #fbbf24; }
        .alert-item.orange { border-left-color: #f59e0b; }
        .alert-item.rouge { border-left-color: #ef4444; }
        .alert-item.violet { border-left-color: #8b5cf6; }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .alert-level {
            font-weight: 700;
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .alert-level.vert { background: #d1fae5; color: #065f46; }
        .alert-level.jaune { background: #fef3c7; color: #92400e; }
        .alert-level.orange { background: #fed7aa; color: #9a3412; }
        .alert-level.rouge { background: #fee2e2; color: #991b1b; }
        .alert-level.violet { background: #ede9fe; color: #5b21b6; }

        .alert-title {
            font-weight: 700;
            color: #1e3a8a;
            font-size: 0.95rem;
        }

        .alert-description {
            color: #475569;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .btn-display {
            position: relative;
        }

        /* Nouveau style pour l'affichage du vent simplifi√© */
        .wind-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-weight: bold;
        }

        .wind-arrow {
            font-size: 1.4rem;
            transition: color 0.3s;
        }

        .wind-value {
            font-size: 0.7rem;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Style pour les heures de lever/coucher de soleil */
        .sun-times {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border: 2px solid #fbbf24;
        }

        .sun-time-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .sun-icon {
            font-size: 1.5rem;
        }

        .sun-label {
            font-size: 0.75rem;
            color: #92400e;
            font-weight: 600;
            text-transform: uppercase;
        }

        .sun-value {
            font-size: 1rem;
            font-weight: 700;
            color: #78350f;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö†Ô∏è Risque & M√©t√©o du Morbihan üå¶Ô∏è</h1>
            <div class="subtitle">Pr√©visions et alertes en temps r√©el</div>
            <div class="last-update" id="last-update">üïí Chargement...</div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>P√©riode :</label>
                <button class="btn btn-period active" data-period="matin">üåÖ Matin</button>
                <button class="btn btn-period" data-period="aprem">üåá Apr√®s-midi</button>
            </div>
            <div class="control-group">
                <label>Affichage :</label>
                <button class="btn btn-display active" data-display="temps">‚òÅÔ∏è Temps</button>
                <button class="btn btn-display" data-display="vent">üí® Vent</button>
                <button class="btn btn-display" data-display="temperature">üå°Ô∏è Temp√©rature</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <div class="map-container" id="map-container">
                    <div style="color: #64748b; font-size: 1.2rem;">üìç Chargement de la carte...</div>
                </div>
            </div>

            <div class="sidebar">
                <div class="info-card">
                    <h2>üìç Informations</h2>
                    <div id="city-info">
                        <div style="text-align: center; color: #64748b; padding: 30px;">
                            üëÜ Cliquez sur une ville pour voir les d√©tails
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h2>‚ö†Ô∏è Alertes Actives</h2>
                    <div id="alerts-container"></div>
                </div>
            </div>
        </div>

        <button class="btn btn-export" onclick="exportData()">üì• Exporter les donn√©es (JSON)</button>

        <footer>
            D√©velopp√© avec üíô pour la s√©curit√© du Morbihan | 
            <a href="https://www.meteofrance.com" target="_blank">Donn√©es M√©t√©o France</a>
        </footer>
    </div>

    <script>
        let currentPeriod = 'matin';
        let currentDisplay = 'temps';
        let selectedCity = null;

        const meteoConfig = {
            dateMiseAJour: "2025-02-02T08:00:00",
            carteImage: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d8/Brittany_in_France_2016.svg/800px-Brittany_in_France_2016.svg.png",
            utiliserIconesPersonnalisees: false,
            cheminIcones: "./icones/",
            extensionIcones: ".png",
            
            // Heures de lever et coucher du soleil (√† adapter selon la date et la localisation)
            sunTimes: {
                sunrise: "08:34",
                sunset: "18:12"
            },
            
            villes: {
                "Vannes": {
                    xPercent: 42,
                    yPercent: 82,
                    matin: {
                        temps: "nuageux",
                        temperature: 8,
                        temperatureMin: 6,
                        temperatureMax: 10,
                        vent: 45,
                        direction: "O",
                        risques: {
                            ventViolent: 3,
                            pluieInondation: 1,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    },
                    aprem: {
                        temps: "pluie",
                        temperature: 11,
                        temperatureMin: 9,
                        temperatureMax: 13,
                        vent: 65,
                        direction: "SO",
                        risques: {
                            ventViolent: 4,
                            pluieInondation: 2,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    }
                },
                "Lorient": {
                    xPercent: 28,
                    yPercent: 78,
                    matin: {
                        temps: "nuageux",
                        temperature: 9,
                        temperatureMin: 7,
                        temperatureMax: 11,
                        vent: 50,
                        direction: "O",
                        risques: {
                            ventViolent: 3,
                            pluieInondation: 1,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    },
                    aprem: {
                        temps: "orageux",
                        temperature: 12,
                        temperatureMin: 10,
                        temperatureMax: 14,
                        vent: 70,
                        direction: "SO",
                        risques: {
                            ventViolent: 4,
                            pluieInondation: 3,
                            orages: 3,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    }
                },
                "Pontivy": {
                    xPercent: 40,
                    yPercent: 50,
                    matin: {
                        temps: "nuageux",
                        temperature: 7,
                        temperatureMin: 5,
                        temperatureMax: 9,
                        vent: 35,
                        direction: "O",
                        risques: {
                            ventViolent: 2,
                            pluieInondation: 1,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    },
                    aprem: {
                        temps: "pluie",
                        temperature: 10,
                        temperatureMin: 8,
                        temperatureMax: 12,
                        vent: 55,
                        direction: "O",
                        risques: {
                            ventViolent: 3,
                            pluieInondation: 2,
                            orages: 1,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    }
                },
                "Auray": {
                    xPercent: 48,
                    yPercent: 78,
                    matin: {
                        temps: "nuageux",
                        temperature: 8,
                        temperatureMin: 6,
                        temperatureMax: 10,
                        vent: 40,
                        direction: "O",
                        risques: {
                            ventViolent: 3,
                            pluieInondation: 1,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    },
                    aprem: {
                        temps: "pluie",
                        temperature: 11,
                        temperatureMin: 9,
                        temperatureMax: 13,
                        vent: 60,
                        direction: "SO",
                        risques: {
                            ventViolent: 4,
                            pluieInondation: 2,
                            orages: 1,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    }
                },
                "Plo√´rmel": {
                    xPercent: 58,
                    yPercent: 55,
                    matin: {
                        temps: "nuageux",
                        temperature: 6,
                        temperatureMin: 4,
                        temperatureMax: 8,
                        vent: 30,
                        direction: "O",
                        risques: {
                            ventViolent: 2,
                            pluieInondation: 1,
                            orages: 0,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    },
                    aprem: {
                        temps: "pluie",
                        temperature: 9,
                        temperatureMin: 7,
                        temperatureMax: 11,
                        vent: 50,
                        direction: "O",
                        risques: {
                            ventViolent: 3,
                            pluieInondation: 2,
                            orages: 1,
                            neige: 0,
                            canicule: 0,
                            grandFroid: 0
                        }
                    }
                }
            }
        };

        const tempsLabels = {
            "ensoleille": "‚òÄÔ∏è Ensoleill√©",
            "nuageux": "‚òÅÔ∏è Nuageux",
            "pluie": "üåßÔ∏è Pluie",
            "orageux": "‚õàÔ∏è Orageux",
            "neige": "üå®Ô∏è Neige",
            "brouillard": "üå´Ô∏è Brouillard"
        };

        const risqueLabels = {
            ventViolent: "Vent violent",
            pluieInondation: "Pluie-Inondation",
            orages: "Orages",
            neige: "Neige-Verglas",
            canicule: "Canicule",
            grandFroid: "Grand froid"
        };

        const risqueToDisplay = {
            ventViolent: "vent",
            pluieInondation: "temps",
            orages: "temps",
            neige: "temps",
            canicule: "temperature",
            grandFroid: "temperature"
        };

        const risqueNiveauDescriptions = {
            0: "Pas de vigilance particuli√®re",
            1: "Pas de vigilance particuli√®re",
            2: "Soyez attentifs",
            3: "‚ö†Ô∏è Soyez tr√®s vigilants - Ph√©nom√®nes habituels mais dangereux",
            4: "üö® Vigilance absolue - Ph√©nom√®nes dangereux",
            5: "üî¥ Vigilance absolue - Ph√©nom√®nes tr√®s dangereux"
        };

        const directionAngles = {
            "N": 0, "NNE": 22.5, "NE": 45, "ENE": 67.5,
            "E": 90, "ESE": 112.5, "SE": 135, "SSE": 157.5,
            "S": 180, "SSO": 202.5, "SO": 225, "OSO": 247.5,
            "O": 270, "ONO": 292.5, "NO": 315, "NNO": 337.5
        };

        const directionLabels = {
            "N": "Nord", "NNE": "Nord-Nord-Est", "NE": "Nord-Est", "ENE": "Est-Nord-Est",
            "E": "Est", "ESE": "Est-Sud-Est", "SE": "Sud-Est", "SSE": "Sud-Sud-Est",
            "S": "Sud", "SSO": "Sud-Sud-Ouest", "SO": "Sud-Ouest", "OSO": "Ouest-Sud-Ouest",
            "O": "Ouest", "ONO": "Ouest-Nord-Ouest", "NO": "Nord-Ouest", "NNO": "Nord-Nord-Ouest"
        };

        // Fonction pour obtenir la couleur de la fl√®che selon la vitesse du vent
        function getWindColor(windSpeed) {
            if (windSpeed < 20) return '#10b981'; // Vert (faible)
            if (windSpeed < 40) return '#fbbf24'; // Jaune (mod√©r√©)
            if (windSpeed < 60) return '#f59e0b'; // Orange (fort)
            if (windSpeed < 80) return '#ef4444'; // Rouge (tr√®s fort)
            return '#8b5cf6'; // Violet (extr√™me)
        }

        function getWeatherIcon(temps) {
            const icons = {
                "ensoleille": "‚òÄÔ∏è",
                "nuageux": "‚òÅÔ∏è",
                "pluie": "üåßÔ∏è",
                "orageux": "‚õàÔ∏è",
                "neige": "üå®Ô∏è",
                "brouillard": "üå´Ô∏è"
            };
            return '<div style="font-size: 2rem;">' + (icons[temps] || "‚ùì") + '</div>';
        }

        function getRisqueColor(niveau) {
            if (niveau <= 1) return '#10b981';
            if (niveau === 2) return '#fbbf24';
            if (niveau === 3) return '#f59e0b';
            if (niveau === 4) return '#ef4444';
            return '#8b5cf6';
        }

        function getMaxRisque(risques) {
            let maxNiveau = 0;
            let maxPhenomene = null;
            Object.entries(risques).forEach(([phenomene, niveau]) => {
                if (niveau > maxNiveau) {
                    maxNiveau = niveau;
                    maxPhenomene = phenomene;
                }
            });
            return { phenomene: maxPhenomene, niveau: maxNiveau };
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(meteoConfig, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "meteo_morbihan_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        function init() {
            loadMap();
            setupControls();
            updateAlerts();
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 60000);
        }

        function updateAlerts() {
            const alertContainer = document.getElementById('alerts-container');
            alertContainer.innerHTML = '';

            const allAlerts = [];

            Object.entries(meteoConfig.villes).forEach(([ville, data]) => {
                ['matin', 'aprem'].forEach(period => {
                    const periodData = data[period];
                    Object.entries(periodData.risques).forEach(([type, niveau]) => {
                        if (niveau >= 3) {
                            allAlerts.push({
                                ville: ville,
                                periode: period === 'matin' ? 'Matin' : 'Apr√®s-midi',
                                type: type,
                                niveau: niveau
                            });
                        }
                    });
                });
            });

            allAlerts.sort((a, b) => b.niveau - a.niveau);

            if (allAlerts.length === 0) {
                alertContainer.innerHTML = '<div style="text-align: center; color: #10b981; padding: 20px; font-weight: 600;">‚úÖ Aucune alerte active</div>';
            } else {
                allAlerts.forEach(alert => {
                    const colorClass = alert.niveau === 3 ? 'orange' : alert.niveau === 4 ? 'rouge' : 'violet';
                    const levelText = alert.niveau === 3 ? 'Orange' : alert.niveau === 4 ? 'Rouge' : 'Violet';
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-item ' + colorClass;
                    alertDiv.innerHTML = '<div class="alert-header"><span class="alert-level ' + colorClass + '">' + levelText + '</span><span class="alert-title">' + risqueLabels[alert.type] + '</span></div><div class="alert-description">üìç ' + alert.ville + ' - ' + alert.periode + '</div>';
                    alertContainer.appendChild(alertDiv);
                }
            });
        }

        function updateRiskBadges() {
            document.querySelectorAll('.risk-badge').forEach(badge => badge.remove());

            let risquesParType = { vent: 0, temps: 0, temperature: 0 };

            Object.values(meteoConfig.villes).forEach(data => {
                const periodData = data[currentPeriod];
                Object.entries(periodData.risques).forEach(([type, niveau]) => {
                    if (niveau >= 3) {
                        const displayType = risqueToDisplay[type];
                        if (niveau > risquesParType[displayType]) {
                            risquesParType[displayType] = niveau;
                        }
                    }
                });
            });

            document.querySelectorAll('.btn-display').forEach(btn => {
                const displayType = btn.dataset.display;
                const risqueNiveau = risquesParType[displayType];

                if (risqueNiveau >= 3) {
                    const badge = document.createElement('span');
                    const badgeClass = risqueNiveau === 3 ? 'orange' : risqueNiveau === 4 ? 'red' : 'violet';
                    badge.className = 'risk-badge ' + badgeClass;
                    badge.textContent = '‚ö†';
                    btn.appendChild(badge);
                }
            });
        }

        function updateLastUpdateTime() {
            const lastUpdate = new Date(meteoConfig.dateMiseAJour);
            const now = new Date();
            const diffMs = now - lastUpdate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);

            let timeAgo = '';
            if (diffMins < 1) {
                timeAgo = '√† l\'instant';
            } else if (diffMins < 60) {
                timeAgo = 'il y a ' + diffMins + ' minute' + (diffMins > 1 ? 's' : '');
            } else if (diffHours < 24) {
                timeAgo = 'il y a ' + diffHours + ' heure' + (diffHours > 1 ? 's' : '');
            } else {
                timeAgo = 'le ' + lastUpdate.toLocaleDateString('fr-FR');
            }

            document.getElementById('last-update').textContent = 'üïí Derni√®re mise √† jour : ' + timeAgo;
        }

        function setupControls() {
            document.querySelectorAll('.btn-period').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    displayWeatherIcons();
                    updateRiskBadges();
                    if (selectedCity) showCityInfo(selectedCity);
                });
            });

            document.querySelectorAll('.btn-display').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.btn-display').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDisplay = btn.dataset.display;
                    displayWeatherIcons();
                });
            });

            updateRiskBadges();
        }

        function loadMap() {
            const container = document.getElementById('map-container');

            if (meteoConfig.carteImage) {
                container.innerHTML = '<img id="map-image" src="' + meteoConfig.carteImage + '" alt="Carte Bretagne">';
                const img = document.getElementById('map-image');

                if (img.complete) {
                    setTimeout(() => displayWeatherIcons(), 100);
                } else {
                    img.addEventListener('load', () => setTimeout(() => displayWeatherIcons(), 100));
                    img.addEventListener('error', () => {
                        console.error('Erreur chargement image');
                        displayWeatherIcons();
                    });
                }
            }
        }

        function displayWeatherIcons() {
            const container = document.getElementById('map-container');
            const mapImage = document.getElementById('map-image');

            document.querySelectorAll('.weather-icon').forEach(icon => icon.remove());
            if (!mapImage) return;

            const rect = mapImage.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            Object.entries(meteoConfig.villes).forEach(([ville, data]) => {
                const periodData = data[currentPeriod];
                const icon = document.createElement('div');
                icon.className = 'weather-icon';
                
                const xPos = (data.xPercent / 100) * rect.width;
                const yPos = (data.yPercent / 100) * rect.height;
                const offsetX = rect.left - containerRect.left;
                const offsetY = rect.top - containerRect.top;
                
                icon.style.left = (offsetX + xPos) + 'px';
                icon.style.top = (offsetY + yPos) + 'px';

                if (currentDisplay === 'temps') {
                    if (meteoConfig.utiliserIconesPersonnalisees) {
                        const imgSrc = meteoConfig.cheminIcones + periodData.temps + meteoConfig.extensionIcones;
                        icon.innerHTML = '<img src="' + imgSrc + '" style="width: 100%; height: 100%; object-fit: contain;" alt="' + periodData.temps + '">';
                    } else {
                        icon.innerHTML = getWeatherIcon(periodData.temps);
                    }
                } else if (currentDisplay === 'vent') {
                    // Nouveau style simplifi√© pour le vent
                    const angle = directionAngles[periodData.direction] || 0;
                    const windColor = getWindColor(periodData.vent);
                    icon.innerHTML = '<div class="wind-display"><div class="wind-arrow" style="transform: rotate(' + angle + 'deg); color: ' + windColor + ';">‚û§</div><div class="wind-value">' + periodData.vent + ' km/h</div></div>';
                } else if (currentDisplay === 'temperature') {
                    const tempColor = periodData.temperature < 5 ? '#3b82f6' : periodData.temperature < 15 ? '#10b981' : '#f59e0b';
                    icon.innerHTML = '<div style="background: ' + tempColor + '; width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">' + periodData.temperature + '¬∞C</div>';
                }

                icon.addEventListener('click', () => showCityInfo(ville));
                container.appendChild(icon);
            });
        }

        function showCityInfo(ville) {
            selectedCity = ville;
            const data = meteoConfig.villes[ville];
            const periodData = data[currentPeriod];
            const periodLabel = currentPeriod === "matin" ? "Matin" : "Apr√®s-midi";
            const maxRisque = getMaxRisque(periodData.risques);

            const risquesActifs = [];
            Object.entries(periodData.risques).forEach(([type, niveau]) => {
                if (niveau > 0) risquesActifs.push({ type, niveau });
            });
            risquesActifs.sort((a, b) => b.niveau - a.niveau);

            // Ajout des heures de lever et coucher du soleil
            let html = '<div class="sun-times">';
            html += '<div class="sun-time-item"><div class="sun-icon">üåÖ</div><div class="sun-label">Lever</div><div class="sun-value">' + meteoConfig.sunTimes.sunrise + '</div></div>';
            html += '<div class="sun-time-item"><div class="sun-icon">üåá</div><div class="sun-label">Coucher</div><div class="sun-value">' + meteoConfig.sunTimes.sunset + '</div></div>';
            html += '</div>';

            html += '<div class="selected-city"><h3>' + ville + '</h3><div class="weather-summary">' + (tempsLabels[periodData.temps] || periodData.temps) + ' - ' + periodLabel + '</div>';
            html += '<div class="param-grid"><div class="param-box"><div class="param-label">üå°Ô∏è Temp√©rature</div><div class="param-value">' + periodData.temperature + '¬∞C</div><div style="font-size: 0.75rem; margin-top: 5px; opacity: 0.85;">Min: ' + periodData.temperatureMin + '¬∞C | Max: ' + periodData.temperatureMax + '¬∞C</div></div><div class="param-box"><div class="param-label">üí® Vent</div><div class="param-value">' + periodData.vent + ' km/h</div><div style="font-size: 0.85rem; margin-top: 5px; opacity: 0.9;">Direction: ' + (directionLabels[periodData.direction] || periodData.direction) + '</div></div></div>';

            if (maxRisque.niveau > 0) {
                const percentageWidth = maxRisque.niveau > 4 ? 100 : (maxRisque.niveau * 25);
                html += '<div class="risk-indicator"><div class="risk-title">‚ö†Ô∏è Risque principal : ' + risqueLabels[maxRisque.phenomene] + ' (' + maxRisque.niveau + '/5)</div><div class="risk-bar"><div class="risk-fill" style="width: ' + percentageWidth + '%; background: ' + getRisqueColor(maxRisque.niveau) + ';">' + maxRisque.niveau + '/5</div></div><div class="risk-description">' + risqueNiveauDescriptions[maxRisque.niveau] + '</div>';

                if (risquesActifs.length > 1) {
                    html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);"><div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 10px;">Autres ph√©nom√®nes :</div>';
                    risquesActifs.forEach(risque => {
                        if (risque.type !== maxRisque.phenomene) {
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px;"><span style="font-size: 0.85rem;">' + risqueLabels[risque.type] + '</span><span style="font-weight: 700; font-size: 0.9rem;">' + risque.niveau + '/5</span></div>';
                        }
                    });
                    html += '</div>';
                }
                html += '</div>';
            } else {
                html += '<div class="risk-indicator"><div class="risk-title">‚úÖ Pas de risque particulier</div><div class="risk-bar"><div class="risk-fill" style="width: 25%; background: #10b981;">Vert</div></div><div class="risk-description">Conditions m√©t√©o favorables</div></div>';
            }

            html += '</div>';
            document.getElementById('city-info').innerHTML = html;
        }

        window.addEventListener('resize', () => {
            if (currentDisplay) displayWeatherIcons();
        });

        init();
    </script>
</body>
</html>
